# -*- coding: utf-8 -*-
"""
Vape Shop Bot ‚Äî full single-file version with:
- Catalog (pods, cartridges, liquids) + add to cart
- Cart review / clear / checkout
- Orders with payment methods (COD, card, crypto)
- User payment confirmation -> admin confirmation
- Admin panel: orders, reviews moderation, referrals stats, broadcast
- Reviews: submit -> moderation -> publish, show last N
- Referral system with /start <ref_id>, spending accumulation, reward threshold
- Persistent storage in ./data/*.json (JSON files), loaded on start and saved on changes
- Basic anti-UX issues: invalidate old inline keyboards via "view tokens"
- RU/UA localization

Library: pyTelegramBotAPI (telebot)
Python: 3.9+
Author: Generated by ChatGPT (GPT-5 Thinking)
"""

import os
import json
import time
import logging
from typing import Dict, List, Any, Optional, Tuple
import telebot
from telebot import types

# ===============================
# --------- CONFIG --------------
# ===============================

TOKEN = os.getenv("8400828602:AAGmF8japcI3YkWRmvd2o9QXoohcYc4I7vQ", "8400828602:AAGmF8japcI3YkWRmvd2o9QXoohcYc4I7vQ")  # <- replace or set env var
ADMIN_CHAT_ID = int(os.getenv("ADMIN_CHAT_ID", "5539798707"))     # <- replace with your Telegram user id

# Payment/Refl thresholds
REF_REWARD_THRESHOLD = 4100

DATA_DIR = os.path.join(os.path.dirname(os.path.abspath(__file__)), "data")
os.makedirs(DATA_DIR, exist_ok=True)

# Files
F_USERS     = os.path.join(DATA_DIR, "users.json")      # {user_id: {"lang": "ru"/"ua", "role": "user"/"admin"}}
F_CARTS     = os.path.join(DATA_DIR, "carts.json")      # {user_id: [product_key, ...]}
F_ORDERS    = os.path.join(DATA_DIR, "orders.json")     # {order_id: {...}}
F_REVIEWS   = os.path.join(DATA_DIR, "reviews.json")    # [{"user_id":..,"text":..,"approved":bool,"created":ts}, ...]
F_REFERRALS = os.path.join(DATA_DIR, "referrals.json")  # {"map": {referrer_id: [child_ids]}, "spending": {referrer_id: sum}}
F_COUNTERS  = os.path.join(DATA_DIR, "counters.json")   # {"order_counter": int}
F_VIEWS     = os.path.join(DATA_DIR, "views.json")      # {"active_view": {user_id: int}}

# ===============================
# --------- LOGGING -------------
# ===============================
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s"
)
log = logging.getLogger("bot")

# ===============================
# --------- STORAGE -------------
# ===============================

def _load(path: str, default):
    try:
        with open(path, "r", encoding="utf-8") as f:
            return json.load(f)
    except Exception:
        return default

def _save(path: str, data):
    tmp = path + ".tmp"
    with open(tmp, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    os.replace(tmp, path)

USERS: Dict[str, Dict[str, Any]] = _load(F_USERS, {})
CARTS: Dict[str, List[str]] = _load(F_CARTS, {})
ORDERS: Dict[str, Dict[str, Any]] = _load(F_ORDERS, {})
REVIEWS: List[Dict[str, Any]] = _load(F_REVIEWS, [])
REF = _load(F_REFERRALS, {"map": {}, "spending": {}})   # "map": {referrer: [childs]}, "spending": {referrer: sum}
COUNTERS = _load(F_COUNTERS, {"order_counter": 1})
VIEWS = _load(F_VIEWS, {"active_view": {}})             # per-user active inline keyboard version

def save_all():
    _save(F_USERS, USERS)
    _save(F_CARTS, CARTS)
    _save(F_ORDERS, ORDERS)
    _save(F_REVIEWS, REVIEWS)
    _save(F_REFERRALS, REF)
    _save(F_COUNTERS, COUNTERS)
    _save(F_VIEWS, VIEWS)

def ensure_user(uid: int):
    uid = str(uid)
    if uid not in USERS:
        USERS[uid] = {"lang": "ru", "role": "admin" if int(uid)==ADMIN_CHAT_ID else "user"}
        _save(F_USERS, USERS)

def get_lang(uid: int) -> str:
    ensure_user(uid)
    return USERS[str(uid)].get("lang", "ru")

def set_lang(uid: int, lang: str):
    ensure_user(uid)
    USERS[str(uid)]["lang"] = lang
    _save(F_USERS, USERS)

def get_role(uid: int) -> str:
    ensure_user(uid)
    return USERS[str(uid)].get("role", "user")

def set_role(uid: int, role: str):
    ensure_user(uid)
    USERS[str(uid)]["role"] = role
    _save(F_USERS, USERS)

def get_cart(uid: int) -> List[str]:
    cart = CARTS.setdefault(str(uid), [])
    _save(F_CARTS, CARTS)
    return cart

def clear_cart(uid: int):
    CARTS[str(uid)] = []
    _save(F_CARTS, CARTS)

def add_to_cart(uid: int, product_key: str):
    cart = get_cart(uid)
    cart.append(product_key)
    _save(F_CARTS, CARTS)

def new_order_id() -> int:
    oid = COUNTERS.get("order_counter", 1)
    COUNTERS["order_counter"] = oid + 1
    _save(F_COUNTERS, COUNTERS)
    return oid

def add_review(user_id: int, text: str):
    REVIEWS.append({"user_id": user_id, "text": text, "approved": False, "created": int(time.time())})
    _save(F_REVIEWS, REVIEWS)

def approve_review(idx: int) -> bool:
    if 0 <= idx < len(REVIEWS):
        REVIEWS[idx]["approved"] = True
        _save(F_REVIEWS, REVIEWS)
        return True
    return False

def delete_review(idx: int) -> bool:
    if 0 <= idx < len(REVIEWS):
        REVIEWS.pop(idx)
        _save(F_REVIEWS, REVIEWS)
        return True
    return False

def add_referral(parent_id: int, child_id: int):
    m = REF["map"].setdefault(str(parent_id), [])
    if str(child_id) not in m and parent_id != child_id:
        m.append(str(child_id))
        _save(F_REFERRALS, REF)

def add_spending(parent_id: int, amount: int):
    cur = int(REF["spending"].get(str(parent_id), 0))
    REF["spending"][str(parent_id)] = cur + int(amount)
    _save(F_REFERRALS, REF)

def get_view_token(uid: int) -> int:
    v = VIEWS["active_view"].get(str(uid), 0) + 1
    VIEWS["active_view"][str(uid)] = v
    _save(F_VIEWS, VIEWS)
    return v

def check_view_token(uid: int, token: int) -> bool:
    return VIEWS["active_view"].get(str(uid), 0) == token

# ===============================
# --------- CATALOG -------------
# ===============================

cartridge_voopoo_price = 145
cartridge_vaporesso_price = 135

PRODUCTS = {
    # Voopoo
    "voopoo_argus_3ml_07": {"name_ru": "Voopoo Argus 3ml 0.7", "name_ua": "Voopoo Argus 3ml 0.7", "price": cartridge_voopoo_price, "category": "voopoo"},
    "voopoo_argus_3ml_10": {"name_ru": "Voopoo Argus 3ml 1.0", "name_ua": "Voopoo Argus 3ml 1.0", "price": cartridge_voopoo_price, "category": "voopoo"},
    "voopoo_argus_3ml_04": {"name_ru": "Voopoo Argus 3ml 0.4", "name_ua": "Voopoo Argus 3ml 0.4", "price": cartridge_voopoo_price, "category": "voopoo"},
    "voopoo_vmate_3ml_07": {"name_ru": "Voopoo Vmate 3ml 0.7", "name_ua": "Voopoo Vmate 3ml 0.7", "price": cartridge_voopoo_price, "category": "voopoo"},
    "voopoo_vmate_2ml_07_tpd": {"name_ru": "Voopoo Vmate 2ml 0.7 (TPD)", "name_ua": "Voopoo Vmate 2ml 0.7 (TPD)", "price": cartridge_voopoo_price, "category": "voopoo"},
    "voopoo_vmate_3ml_04": {"name_ru": "Voopoo Vmate 3ml 0.4", "name_ua": "Voopoo Vmate 3ml 0.4", "price": cartridge_voopoo_price, "category": "voopoo"},
    "voopoo_vmate_2ml_04_tpd": {"name_ru": "Voopoo Vmate 2ml 0.4 (TPD)", "name_ua": "Voopoo Vmate 2ml 0.4 (TPD)", "price": cartridge_voopoo_price, "category": "voopoo"},

    # Elf Bar ELFX
    "elfx_2ml_06": {"name_ru": "Elfx 2ml 0.6", "name_ua": "Elfx 2ml 0.6", "price": 135, "category": "elfx"},
    "elfx_2ml_08": {"name_ru": "Elfx 2ml 0.8", "name_ua": "Elfx 2ml 0.8", "price": 135, "category": "elfx"},

    # Vaporesso
    "vaporesso_xros_1_0_3ml": {"name_ru": "Vaporesso Xros Series 1.0, 3 ml", "name_ua": "Vaporesso Xros Series 1.0, 3 ml", "price": cartridge_vaporesso_price, "category": "vaporesso"},
    "vaporesso_xros_1_0_2ml": {"name_ru": "Vaporesso Xros Series 1.0, 2 ml", "name_ua": "Vaporesso Xros Series 1.0, 2 ml", "price": cartridge_vaporesso_price, "category": "vaporesso"},
    "vaporesso_xros_0_8_3ml": {"name_ru": "Vaporesso Xros Series 0.8, 3 ml", "name_ua": "Vaporesso Xros Series 0.8, 3 ml", "price": cartridge_vaporesso_price, "category": "vaporesso"},
    "vaporesso_xros_0_8_2ml": {"name_ru": "Vaporesso Xros Series 0.8, 2 ml", "name_ua": "Vaporesso Xros Series 0.8, 2 ml", "price": cartridge_vaporesso_price, "category": "vaporesso"},
    "vaporesso_xros_0_6_3ml": {"name_ru": "Vaporesso Xros Series 0.6, 3 ml", "name_ua": "Vaporesso Xros Series 0.6, 3 ml", "price": cartridge_vaporesso_price, "category": "vaporesso"},
    "vaporesso_xros_0_6_2ml": {"name_ru": "Vaporesso Xros Series 0.6, 2 ml", "name_ua": "Vaporesso Xros Series 0.6, 2 ml", "price": cartridge_vaporesso_price, "category": "vaporesso"},
    "vaporesso_xros_0_4_3ml": {"name_ru": "Vaporesso Xros Series 0.4, 3 ml", "name_ua": "Vaporesso Xros Series 0.4, 3 ml", "price": cartridge_vaporesso_price, "category": "vaporesso"},
    "vaporesso_xros_0_4_2ml": {"name_ru": "Vaporesso Xros Series 0.4, 2 ml", "name_ua": "Vaporesso Xros Series 0.4, 2 ml", "price": cartridge_vaporesso_price, "category": "vaporesso"},
}

PODS = {
    "vaporesso_xros_5_mini": {"name_ru": "Vaporesso xros 5 mini", "name_ua": "Vaporesso xros 5 mini", "price": 850},
    "vaporesso_xros_4_mini": {"name_ru": "Vaporesso xros 4 mini", "name_ua": "Vaporesso xros 4 mini", "price": 809},
    "vaporesso_xros_5": {"name_ru": "Vaporesso xros 5", "name_ua": "Vaporesso xros 5", "price": 1129},
    "elfx_pro": {"name_ru": "Elbar Bar ELFX Pro", "name_ua": "Elbar Bar ELFX Pro", "price": 849},
    "elf_bar_ev15000": {"name_ru": "Elf Bar EV15000", "name_ua": "Elf Bar EV15000", "price": 299},
    "voopoo_argus_g2": {"name_ru": "Voopoo Argus G2", "name_ua": "Voopoo Argus G2", "price": 1049},
    "voopoo_vmate_i2": {"name_ru": "Voopoo Vmate I2 (–≤—Ç–æ—Ä–æ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ)", "name_ua": "Voopoo Vmate I2 (–¥—Ä—É–≥–µ –ø–æ–∫–æ–ª—ñ–Ω–Ω—è)", "price": 719},
}

LIQUIDS = {
    "chaser_30_watermelon": {"name_ru": "Chaser (–ê—Ä–±—É–∑)", "name_ua": "Chaser (–ö–∞–≤—É–Ω)", "price": 285, "category": "chaser_30"},
    "chaser_30_peach": {"name_ru": "Chaser (–ü–µ—Ä—Å–∏–∫)", "name_ua": "Chaser (–ü–µ—Ä—Å–∏–∫)", "price": 285, "category": "chaser_30"},
    "chaser_30_berries": {"name_ru": "Chaser (–Ø–≥–æ–¥—ã)", "name_ua": "Chaser (–Ø–≥–æ–¥–∏)", "price": 285, "category": "chaser_30"},
    "chaser_30_banana": {"name_ru": "Chaser (–ë–∞–Ω–∞–Ω)", "name_ua": "Chaser (–ë–∞–Ω–∞–Ω)", "price": 285, "category": "chaser_30"},
    "chaser_30_blue_raspberry": {"name_ru": "Chaser (–ì–æ–ª—É–±–∞—è –º–∞–ª–∏–Ω–∞)", "name_ua": "Chaser (–ë–ª–∞–∫–∏—Ç–Ω–∞ –º–∞–ª–∏–Ω–∞)", "price": 285, "category": "chaser_30"},
    "chaser_30_grape": {"name_ru": "Chaser (–í–∏–Ω–æ–≥—Ä–∞–¥)", "name_ua": "Chaser (–í–∏–Ω–æ–≥—Ä–∞–¥)", "price": 285, "category": "chaser_30"},
    "chaser_30_cherry": {"name_ru": "Chaser (–í–∏—à–Ω—è)", "name_ua": "Chaser (–í–∏—à–Ω—è)", "price": 285, "category": "chaser_30"},
    "chaser_30_cherry_menthol": {"name_ru": "Chaser (–í–∏—à–Ω—è –º–µ–Ω—Ç–æ–ª)", "name_ua": "Chaser (–í–∏—à–Ω—è –º–µ–Ω—Ç–æ–ª)", "price": 285, "category": "chaser_30"},
    "chaser_30_pomegranate": {"name_ru": "Chaser (–ì—Ä–∞–Ω–∞—Ç)", "name_ua": "Chaser (–ì—Ä–∞–Ω–∞—Ç)", "price": 285, "category": "chaser_30"},
    "chaser_30_melon": {"name_ru": "Chaser (–î—ã–Ω—è)", "name_ua": "Chaser (–î–∏–Ω—è)", "price": 285, "category": "chaser_30"},
    "chaser_30_yellow_raspberry": {"name_ru": "Chaser (–ñ–µ–ª—Ç–∞—è –º–∞–ª–∏–Ω–∞)", "name_ua": "Chaser (–ñ–æ–≤—Ç–∞ –º–∞–ª–∏–Ω–∞)", "price": 285, "category": "chaser_30"},
    "chaser_30_yellow_cherry": {"name_ru": "Chaser (–ñ–µ–ª—Ç–∞—è —á–µ—Ä–µ—à–Ω—è)", "name_ua": "Chaser (–ñ–æ–≤—Ç–∞ —á–µ—Ä–µ—à–Ω—è)", "price": 285, "category": "chaser_30"},
    "chaser_30_yellow_dragonfruit": {"name_ru": "Chaser (–ñ—ë–ª—Ç—ã–π –¥—Ä–∞–≥–æ–Ω—Ñ—Ä—É–∫—Ç)", "name_ua": "Chaser (–ñ–æ–≤—Ç–∏–π –¥—Ä–∞–≥–æ–Ω—Ñ—Ä—É–∫—Ç)", "price": 285, "category": "chaser_30"},
    "chaser_30_kiwi": {"name_ru": "Chaser (–ö–∏–≤–∏)", "name_ua": "Chaser (–ö—ñ–≤—ñ)", "price": 285, "category": "chaser_30"},

    "chaser_10_banana": {"name_ru": "Chaser (–ë–∞–Ω–∞–Ω)", "name_ua": "Chaser (–ë–∞–Ω–∞–Ω)", "price": 152, "category": "chaser_10"},
    "chaser_10_blue_raspberry": {"name_ru": "Chaser (–ì–æ–ª—É–±–∞—è –º–∞–ª–∏–Ω–∞)", "name_ua": "Chaser (–ë–ª–∞–∫–∏—Ç–Ω–∞ –º–∞–ª–∏–Ω–∞)", "price": 152, "category": "chaser_10"},
    "chaser_10_grape": {"name_ru": "Chaser (–í–∏–Ω–æ–≥—Ä–∞–¥)", "name_ua": "Chaser (–í–∏–Ω–æ–≥—Ä–∞–¥)", "price": 152, "category": "chaser_10"},
    "chaser_10_cherry": {"name_ru": "Chaser (–í–∏—à–Ω—è)", "name_ua": "Chaser (–í–∏—à–Ω—è)", "price": 152, "category": "chaser_10"},
    "chaser_10_cherry_menthol": {"name_ru": "Chaser (–í–∏—à–Ω—è –º–µ–Ω—Ç–æ–ª)", "name_ua": "Chaser (–í–∏—à–Ω—è –º–µ–Ω—Ç–æ–ª)", "price": 152, "category": "chaser_10"},
    "chaser_10_pomegranate": {"name_ru": "Chaser (–ì—Ä–∞–Ω–∞—Ç)", "name_ua": "Chaser (–ì—Ä–∞–Ω–∞—Ç)", "price": 152, "category": "chaser_10"},
    "chaser_10_melon": {"name_ru": "Chaser (–î—ã–Ω—è)", "name_ua": "Chaser (–î—ã–Ω—è)", "price": 152, "category": "chaser_10"},
    "chaser_10_watermelon": {"name_ru": "Chaser (–ê—Ä–±—É–∑)", "name_ua": "Chaser (–ö–∞–≤—É–Ω)", "price": 152, "category": "chaser_10"},
    "chaser_10_watermelon_menthol": {"name_ru": "Chaser (–ê—Ä–±—É–∑ –º–µ–Ω—Ç–æ–ª)", "name_ua": "Chaser (–ö–∞–≤—É–Ω –º–µ–Ω—Ç–æ–ª)", "price": 152, "category": "chaser_10"},
    "chaser_10_kiwi": {"name_ru": "Chaser (–ö–∏–≤–∏)", "name_ua": "Chaser (–ö—ñ–≤—ñ)", "price": 152, "category": "chaser_10"},
    "chaser_10_lemon": {"name_ru": "Chaser (–õ–∏–º–æ–Ω)", "name_ua": "Chaser (–õ–∏–º–æ–Ω)", "price": 152, "category": "chaser_10"},
    "chaser_10_mint": {"name_ru": "Chaser (–ú—è—Ç–∞)", "name_ua": "Chaser (–ú º—è—Ç–∞)", "price": 152, "category": "chaser_10"},
    "chaser_10_peach": {"name_ru": "Chaser (–ü–µ—Ä—Å–∏–∫)", "name_ua": "Chaser (–ü–µ—Ä—Å–∏–∫)", "price": 152, "category": "chaser_10"},
    "chaser_10_strawberry": {"name_ru": "Chaser (–ö–ª—É–±–Ω–∏–∫–∞)", "name_ua": "Chaser (–ü–æ–ª—É–Ω–∏—Ü—è)", "price": 152, "category": "chaser_10"},
    "chaser_10_blackcurrant_menthol": {"name_ru": "Chaser (–°–º–æ—Ä–æ–¥–∏–Ω–∞ –º–µ–Ω—Ç–æ–ª)", "name_ua": "Chaser (–°–º–æ—Ä–æ–¥–∏–Ω–∞ –º–µ–Ω—Ç–æ–ª)", "price": 152, "category": "chaser_10"},
    "chaser_10_blueberry_menthol": {"name_ru": "Chaser (–ß–µ—Ä–Ω–∏–∫–∞ –º–µ–Ω—Ç–æ–ª)", "name_ua": "Chaser (–ß–æ—Ä–Ω–∏—Ü—è –º–µ–Ω—Ç–æ–ª)", "price": 152, "category": "chaser_10"},
    "chaser_10_berries": {"name_ru": "Chaser (–Ø–≥–æ–¥—ã)", "name_ua": "Chaser (–Ø–≥–æ–¥–∏)", "price": 152, "category": "chaser_10"},

    "elfliq_10_apple_peach": {"name_ru": "Elfliq (–Ø–±–ª–æ–∫–æ-–ü–µ—Ä—Å–∏–∫)", "name_ua": "Elfliq (–Ø–±–ª—É–∫–æ-–ü–µ—Ä—Å–∏–∫)", "price": 153, "category": "elfliq_10"},
    "elfliq_10_lemonade": {"name_ru": "Elfliq (–õ–∏–º–æ–Ω–∞–¥)", "name_ua": "Elfliq (–õ–∏–º–æ–Ω–∞–¥)", "price": 153, "category": "elfliq_10"},
    "elfliq_10_blueberry": {"name_ru": "Elfliq (–ß–µ—Ä–Ω–∏–∫–∞)", "name_ua": "Elfliq (–ß–æ—Ä–Ω–∏—Ü—è)", "price": 153, "category": "elfliq_10"},
    "elfliq_10_blueberry_raspberry": {"name_ru": "Elfliq (–ß–µ—Ä–Ω–∏–∫–∞-–ö–∏—Å–ª–∞—è-–ú–∞–ª–∏–Ω–∞)", "name_ua": "Elfliq (–ß–æ—Ä–Ω–∏—Ü—è-–ö–∏—Å–ª–∞-–ú–∞–ª–∏–Ω–∞)", "price": 153, "category": "elfliq_10"},
    "elfliq_10_cherry": {"name_ru": "Elfliq (–í–∏—à–Ω—è)", "name_ua": "Elfliq (–í–∏—à–Ω—è)", "price": 153, "category": "elfliq_10"},
    "elfliq_10_cherry_cola": {"name_ru": "Elfliq (–í–∏—à–Ω–µ–≤–∞—è –ö–æ–ª–∞)", "name_ua": "Elfliq (–í–∏—à–Ω–µ–≤–∞ –ö–æ–ª–∞)", "price": 153, "category": "elfliq_10"},
    "elfliq_10_cola": {"name_ru": "Elfliq (–ö–æ–ª–∞)", "name_ua": "Elfliq (–ö–æ–ª–∞)", "price": 153, "category": "elfliq_10"},
    "elfliq_10_pb_cloud": {"name_ru": "Elfliq (P&B Cloud - –ó–µ—Ñ–∏—Ä)", "name_ua": "Elfliq (P&B Cloud - –ó–µ—Ñ—ñ—Ä)", "price": 153, "category": "elfliq_10"},
    "elfliq_10_energy": {"name_ru": "Elfliq (–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫)", "name_ua": "Elfliq (–ï–Ω–µ—Ä–≥–µ—Ç–∏–∫)", "price": 153, "category": "elfliq_10"},
    "elfliq_10_grape": {"name_ru": "Elfliq (–í–∏–Ω–æ–≥—Ä–∞–¥)", "name_ua": "Elfliq (–í–∏–Ω–æ–≥—Ä–∞–¥)", "price": 153, "category": "elfliq_10"},
    "elfliq_10_kiwi_passion_guava": {"name_ru": "Elfliq (–ö–∏–≤–∏-–ú–∞—Ä–∞–∫—É–π—è-–ì—É–∞–≤–∞)", "name_ua": "Elfliq (–ö—ñ–≤—ñ-–ú–∞—Ä–∞–∫—É–π—è-–ì—É–∞–≤–∞)", "price": 153, "category": "elfliq_10"},
    "elfliq_10_peach_ice": {"name_ru": "Elfliq (–ü–µ—Ä—Å–∏–∫–æ–≤—ã–π –ª—ë–¥)", "name_ua": "Elfliq (–ü–µ—Ä—Å–∏–∫–æ–≤–∏–π –ª—ñ–¥)", "price": 153, "category": "elfliq_10"},
    "elfliq_10_pink_grapefruit": {"name_ru": "Elfliq (–†–æ–∑–æ–≤—ã–π –≥—Ä–µ–π–ø—Ñ—Ä—É—Ç)", "name_ua": "Elfliq (–†–æ–∂–µ–≤–∏–π –≥—Ä–µ–π–ø—Ñ—Ä—É—Ç)", "price": 153, "category": "elfliq_10"},

    "elfliq_30_blue_pink_lemonade": {"name_ru": "Elfliq (–°–∏–Ω–µ-—Ä–æ–∑–æ–≤—ã–π –ª–∏–º–æ–Ω–∞–¥)", "name_ua": "Elfliq (–°–∏–Ω—å–æ-—Ä–æ–∂–µ–≤–∏–π –ª–∏–º–æ–Ω–∞–¥)", "price": 299, "category": "elfliq_30"},
    "elfliq_30_blueberry_raspberry": {"name_ru": "Elfliq (–ß–µ—Ä–Ω–∏–∫–∞ –∫–∏—Å–ª–∞—è –º–∞–ª–∏–Ω–∞)", "name_ua": "Elfliq (–ß–æ—Ä–Ω–∏—Ü—è –∫–∏—Å–ª–∞ –º–∞–ª–∏–Ω–∞)", "price": 299, "category": "elfliq_30"},
    "elfliq_30_watermelon": {"name_ru": "Elfliq (–ê—Ä–±—É–∑)", "name_ua": "Elfliq (–ö–∞–≤—É–Ω)", "price": 299, "category": "elfliq_30"},
    "elfliq_30_kiwi_passion_guava": {"name_ru": "Elfliq (–ö–∏–≤–∏ –º–∞—Ä–∞–∫—É–π—è –≥—É–∞–≤–∞)", "name_ua": "Elfliq (–ö—ñ–≤—ñ –º–∞—Ä–∞–∫—É–π—è –≥—É–∞–≤–∞)", "price": 299, "category": "elfliq_30"},
    "elfliq_30_cream_tobacco": {"name_ru": "Elfliq (–°–ª–∏–≤–∫–∏ —Ç–∞–±–∞–∫)", "name_ua": "Elfliq (–°–ª–∏–≤–∫–∏ —Ç—é—Ç—é–Ω)", "price": 299, "category": "elfliq_30"},
    "elfliq_30_cola": {"name_ru": "Elfliq (–ö–æ–ª–∞)", "name_ua": "Elfliq (–ö–æ–ª–∞)", "price": 299, "category": "elfliq_30"},
    "elfliq_30_apple_peach": {"name_ru": "Elfliq (–Ø–±–ª–æ–∫–æ –ø–µ—Ä—Å–∏–∫)", "name_ua": "Elfliq (–Ø–±–ª—É–∫–æ –ø–µ—Ä—Å–∏–∫)", "price": 299, "category": "elfliq_30"},
    "elfliq_30_raspberry": {"name_ru": "Elfliq (–ú–∞–ª–∏–Ω–∞)", "name_ua": "Elfliq (–ú–∞–ª–∏–Ω–∞)", "price": 299, "category": "elfliq_30"},
    "elfliq_30_mint": {"name_ru": "Elfliq (–ú—è—Ç–∞)", "name_ua": "Elfliq (–ú º—è—Ç–∞)", "price": 299, "category": "elfliq_30"},
    "elfliq_30_peach": {"name_ru": "Elfliq (–ü–µ—Ä—Å–∏–∫)", "name_ua": "Elfliq (–ü–µ—Ä—Å–∏–∫)", "price": 299, "category": "elfliq_30"},

    "elix_10_watermelon_mint": {"name_ru": "Elix (–ê—Ä–±—É–∑-–ú—è—Ç–∞)", "name_ua": "Elix (–ö–∞–≤—É–Ω-–ú º—è—Ç–∞)", "price": 146, "category": "elix_10"},
    "elix_10_banana": {"name_ru": "Elix (–ë–∞–Ω–∞–Ω)", "name_ua": "Elix (–ë–∞–Ω–∞–Ω)", "price": 146, "category": "elix_10"},
    "elix_10_grape": {"name_ru": "Elix (–í–∏–Ω–æ–≥—Ä–∞–¥)", "name_ua": "Elix (–í–∏–Ω–æ–≥—Ä–∞–¥)", "price": 146, "category": "elix_10"},
    "elix_10_blue_raspberry_mint": {"name_ru": "Elix (–ì–æ–ª—É–±–∞—è –º–∞–ª–∏–Ω–∞ –º—è—Ç–∞)", "name_ua": "Elix (–ë–ª–∞–∫–∏—Ç–Ω–∞ –º–∞–ª–∏–Ω–∞ –º º—è—Ç–∞)", "price": 146, "category": "elix_10"},
    "elix_10_grapefruit": {"name_ru": "Elix (–ì—Ä–µ–π–ø—Ñ—Ä—É—Ç)", "name_ua": "Elix (–ì—Ä–µ–π–ø—Ñ—Ä—É—Ç)", "price": 146, "category": "elix_10"},
    "elix_10_pear": {"name_ru": "Elix (–ì—Ä—É—à–∞)", "name_ua": "Elix (–ì—Ä—É—à–∞)", "price": 146, "category": "elix_10"},
    "elix_10_melon": {"name_ru": "Elix (–î—ã–Ω—è)", "name_ua": "Elix (–î—ã–Ω—è)", "price": 146, "category": "elix_10"},
    "elix_10_green_apple": {"name_ru": "Elix (–ó–µ–ª–µ–Ω–æ–µ —è–±–ª–æ–∫–æ)", "name_ua": "Elix (–ó–µ–ª–µ–Ω–µ —è–±–ª—É–∫–æ)", "price": 146, "category": "elix_10"},
    "elix_10_wild_strawberry": {"name_ru": "Elix (–ó–µ–º–ª—è–Ω–∏–∫–∞)", "name_ua": "Elix (–°—É–Ω–∏—Ü—è)", "price": 146, "category": "elix_10"},
    "elix_10_red_raspberry": {"name_ru": "Elix (–ö—Ä–∞—Å–Ω–∞—è –º–∞–ª–∏–Ω–∞)", "name_ua": "Elix (–ß–µ—Ä–≤–æ–Ω–∞ –º–∞–ª–∏–Ω–∞)", "price": 146, "category": "elix_10"},
    "elix_10_forest_berries": {"name_ru": "Elix (–õ–µ—Å–Ω—ã–µ —è–≥–æ–¥—ã)", "name_ua": "Elix (–õ—ñ—Å–æ–≤—ñ —è–≥–æ–¥–∏)", "price": 146, "category": "elix_10"},
    "elix_10_lychee": {"name_ru": "Elix (–õ–∏—á–∏)", "name_ua": "Elix (–õ—ñ—á—ñ)", "price": 146, "category": "elix_10"},
    "elix_10_mint": {"name_ru": "Elix (–ú—è—Ç–∞)", "name_ua": "Elix (–ú º—è—Ç–∞)", "price": 146, "category": "elix_10"},
    "elix_10_nectarine": {"name_ru": "Elix (–ù–µ–∫—Ç–∞—Ä–∏–Ω)", "name_ua": "Elix (–ù–µ–∫—Ç–∞—Ä–∏–Ω)", "price": 146, "category": "elix_10"},
    "elix_10_blackcurrant_mint": {"name_ru": "Elix (–°–º–æ—Ä–æ–¥–∏–Ω–∞ –º—è—Ç–∞)", "name_ua": "Elix (–°–º–æ—Ä–æ–¥–∏–Ω–∞ –º º—è—Ç–∞)", "price": 146, "category": "elix_10"},
    "elix_10_cherry": {"name_ru": "Elix (–ß–µ—Ä–µ—à–Ω—è)", "name_ua": "Elix (–ß–µ—Ä–µ—à–Ω—è)", "price": 146, "category": "elix_10"},

    "elix_30_blue_raspberry_mint": {"name_ru": "Elix (–ì–æ–ª—É–±–∞—è –º–∞–ª–∏–Ω–∞ –º—è—Ç–∞)", "name_ua": "Elix (–ë–ª–∞–∫–∏—Ç–Ω–∞ –º–∞–ª–∏–Ω–∞ –º º—è—Ç–∞)", "price": 277, "category": "elix_30"},
    "elix_30_wild_strawberry": {"name_ru": "Elix (–ó–µ–º–ª—è–Ω–∏–∫–∞)", "name_ua": "Elix (–°—É–Ω–∏—Ü—è)", "price": 277, "category": "elix_30"},
    "elix_30_blackcurrant_mint": {"name_ru": "Elix (–°–º–æ—Ä–æ–¥–∏–Ω–∞ –º—è—Ç–∞)", "name_ua": "Elix (–°–º–æ—Ä–æ–¥–∏–Ω–∞ –º º—è—Ç–∞)", "price": 277, "category": "elix_30"},
    "elix_30_green_apple": {"name_ru": "Elix (–ó–µ–ª–µ–Ω–æ–µ —è–±–ª–æ–∫–æ)", "name_ua": "Elix (–ó–µ–ª–µ–Ω–µ —è–±–ª—É–∫–æ)", "price": 277, "category": "elix_30"},
    "elix_30_lychee": {"name_ru": "Elix (–õ–∏—á–∏)", "name_ua": "Elix (–õ—ñ—á—ñ)", "price": 277, "category": "elix_30"},
    "elix_30_watermelon_mint": {"name_ru": "Elix (–ê—Ä–±—É–∑ –º—è—Ç–∞)", "name_ua": "Elix (–ö–∞–≤—É–Ω –º º—è—Ç–∞)", "price": 277, "category": "elix_30"},
    "elix_30_red_raspberry": {"name_ru": "Elix (–ö—Ä–∞—Å–Ω–∞—è –º–∞–ª–∏–Ω–∞)", "name_ua": "Elix (–ß–µ—Ä–≤–æ–Ω–∞ –º–∞–ª–∏–Ω–∞)", "price": 277, "category": "elix_30"},
    "elix_30_melon": {"name_ru": "Elix (–î—ã–Ω—è)", "name_ua": "Elix (–î—ã–Ω—è)", "price": 277, "category": "elix_30"},
    "elix_30_cherry": {"name_ru": "Elix (–ß–µ—Ä–µ—à–Ω—è)", "name_ua": "Elix (–ß–µ—Ä–µ—à–Ω—è)", "price": 277, "category": "elix_30"},
    "elix_30_banana": {"name_ru": "Elix (–ë–∞–Ω–∞–Ω)", "name_ua": "Elix (–ë–∞–Ω–∞–Ω)", "price": 277, "category": "elix_30"},
    "elix_30_grapefruit": {"name_ru": "Elix (–ì—Ä–µ–π–ø—Ñ—Ä—É—Ç)", "name_ua": "Elix (–ì—Ä–µ–π–ø—Ñ—Ä—É—Ç)", "price": 277, "category": "elix_30"},
    "elix_30_grape": {"name_ru": "Elix (–í–∏–Ω–æ–≥—Ä–∞–¥)", "name_ua": "Elix (–í–∏–Ω–æ–≥—Ä–∞–¥)", "price": 277, "category": "elix_30"},
    "elix_30_pear": {"name_ru": "Elix (–ì—Ä—É—à–∞)", "name_ua": "Elix (–ì—Ä—É—à–∞)", "price": 277, "category": "elix_30"},
    "elix_30_forest_berries": {"name_ru": "Elix (–õ–µ—Å–Ω—ã–µ —è–≥–æ–¥—ã)", "name_ua": "Elix (–õ—ñ—Å–æ–≤—ñ —è–≥–æ–¥–∏)", "price": 277, "category": "elix_30"},
    "elix_30_nectarine": {"name_ru": "Elix (–ù–µ–∫—Ç–∞—Ä–∏–Ω)", "name_ua": "Elix (–ù–µ–∫—Ç–∞—Ä–∏–Ω)", "price": 277, "category": "elix_30"},
    "elix_30_mint": {"name_ru": "Elix (–ú—è—Ç–∞)", "name_ua": "Elix (–ú º—è—Ç–∞)", "price": 277, "category": "elix_30"},
}

# ===============================
# --------- I18N ----------------
# ===============================

def t(key: str, lang: str) -> str:
    texts = {
        "language_select": {"ru": "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / –û–±–µ—Ä—ñ—Ç—å –º–æ–≤—É:", "ua": "–û–±–µ—Ä—ñ—Ç—å –º–æ–≤—É / –í–∏–±–µ—Ä—ñ—Ç—å —è–∑—ã–∫:"},
        "main_menu": {"ru": "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "ua": "–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é"},
        "catalog": {"ru": "–ö–∞—Ç–∞–ª–æ–≥", "ua": "–ö–∞—Ç–∞–ª–æ–≥"},
        "cartridges": {"ru": "–ö–∞—Ä—Ç—Ä–∏–¥–∂–∏", "ua": "–ö–∞—Ä—Ç—Ä–∏–¥–∂—ñ"},
        "pods": {"ru": "–ü–æ–¥ —Å–∏—Å—Ç–µ–º—ã", "ua": "–ü–æ–¥ —Å–∏—Å—Ç–µ–º–∏"},
        "liquids": {"ru": "–ñ–∏–¥–∫–æ—Å—Ç–∏", "ua": "–†—ñ–¥–∏–Ω–∏"},
        "back": {"ru": "–ù–∞–∑–∞–¥", "ua": "–ù–∞–∑–∞–¥"},
        "cart": {"ru": "–ö–æ—Ä–∑–∏–Ω–∞", "ua": "–ö–æ—à–∏–∫"},
        "cart_empty": {"ru": "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞", "ua": "–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π"},
        "cart_cleared": {"ru": "–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞", "ua": "–ö–æ—à–∏–∫ –æ—á–∏—â–µ–Ω–æ"},
        "add_cart_success": {"ru": "–¢–æ–≤–∞—Ä {name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É", "ua": "–¢–æ–≤–∞—Ä {name} –¥–æ–¥–∞–Ω–æ –≤ –∫–æ—à–∏–∫"},
        "checkout": {"ru": "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑", "ua": "–û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"},
        "orders": {"ru": "–ú–æ–∏ –∑–∞–∫–∞–∑—ã", "ua": "–ú–æ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"},
        "orders_empty": {"ru": "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.", "ua": "–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î –∑–∞–º–æ–≤–ª–µ–Ω—å."},
        "order_created": {"ru": "–ó–∞–∫–∞–∑ #{order_id} —Å–æ–∑–¥–∞–Ω!", "ua": "–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #{order_id} —Å—Ç–≤–æ—Ä–µ–Ω–æ!"},
        "pay_cod": {"ru": "–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏", "ua": "–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ"},
        "pay_card": {"ru": "–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π", "ua": "–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–∫–æ—é"},
        "pay_crypto": {"ru": "–û–ø–ª–∞—Ç–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π", "ua": "–û–ø–ª–∞—Ç–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ—é"},
        "pay_prepay_info": {
            "ru": "–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π. –í–Ω–∏–º–∞–Ω–∏–µ! –ü–µ—Ä–µ–≤–æ–¥—ã –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å –∫–∞—Ä—Ç—ã Monobank. –ò–Ω–∞—á–µ –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω.\n\n–í–ª–∞–¥–∏—Å–ª–∞–≤ –ì.\n4441 1110 3909 5051\n\n–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
            "ua": "–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–∫–æ—é. –£–≤–∞–≥–∞! –ü–µ—Ä–µ–∫–∞–∑–∏ –ø—Ä–∏–π–º–∞—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –∑ –∫–∞—Ä—Ç–∫–∏ Monobank. –Ü–Ω–∞–∫—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –±—É–¥–µ –∞–Ω—É–ª—å–æ–≤–∞–Ω–æ.\n\n–í–ª–∞–¥–∏—Å–ª–∞–≤ –ì.\n4441 1110 3909 5051\n\n–ü—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ."
        },
        "pay_crypto_info": {
            "ru": "–û–ø–ª–∞—Ç–∏—Ç–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π –Ω–∞ –∞–¥—Ä–µ—Å –Ω–∏–∂–µ.\n\nTON Wallet:\nUQDjclQadIIq-DUoTNY53oHfcp9WVi5mRVnUVxVUnQ-vznEc\n\n–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
            "ua": "–û–ø–ª–∞—Ç—ñ—Ç—å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ—é –∑–∞ –∞–¥—Ä–µ—Å–æ—é –Ω–∏–∂—á–µ.\n\nTON Wallet:\nUQDjclQadIIq-DUoTNY53oHfcp9WVi5mRV–ΩUVxVUnQ-vznEc\n\n–ü—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ."
        },
        "pay_done": {"ru": "–û–ø–ª–∞—á–µ–Ω–æ", "ua": "–û–ø–ª–∞—á–µ–Ω–æ"},
        "pay_done_wait": {"ru": "–í–∞—à –ø–ª–∞—Ç–µ–∂ –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.", "ua": "–í–∞—à –ø–ª–∞—Ç—ñ–∂ –æ—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞."},
        "pay_confirmed": {"ru": "–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –°–∫–æ—Ä–æ —Å –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è.", "ua": "–û–ø–ª–∞—Ç–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∞! –ù–µ–∑–∞–±–∞—Ä–æ–º –∑ –≤–∞–º–∏ –∑–≤'—è–∂—É—Ç—å—Å—è."},
        "order_status_paid": {"ru": "–û–ø–ª–∞—á–µ–Ω ‚úÖ", "ua": "–û–ø–ª–∞—á–µ–Ω–æ ‚úÖ"},
        "order_status_completed": {"ru": "–ó–∞–≤–µ—Ä—à—ë–Ω ‚úÖ", "ua": "–ó–∞–≤–µ—Ä—à–µ–Ω–æ ‚úÖ"},
        "confirm_received": {"ru": "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ", "ua": "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è"},
        "referral": {"ru": "–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞", "ua": "–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞ —Å–∏—Å—Ç–µ–º–∞"},
        "referral_link_caption": {"ru": "–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:", "ua": "–í–∞—à–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è:"},
        "referral_notify": {
            "ru": "–í–∞—à–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã —Å–æ–≤–µ—Ä—à–∏–ª–∏ –ø–æ–∫—É–ø–∫–∏ –Ω–∞ —Å—É–º–º—É {sum} –≥—Ä–Ω. –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –ø–æ–¥–∞—Ä–æ–∫ - –ª—é–±—É—é –∂–∏–¥–∫–æ—Å—Ç—å –∏–∑ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞ –∏–ª–∏ –ª—é–±—ã–µ –¥–≤–∞ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞ –Ω–∞ –≤—ã–±–æ—Ä.", "ua": "–í–∞—à—ñ —Ä–µ—Ñ–µ—Ä–∞–ª–∏ –∑–¥—ñ–π—Å–Ω–∏–ª–∏ –ø–æ–∫—É–ø–∫–∏ –Ω–∞ —Å—É–º—É {sum} –≥—Ä–Ω. –í–∏ –æ—Ç—Ä–∏–º—É—î—Ç–µ –ø–æ–¥–∞—Ä—É–Ω–æ–∫ - –±—É–¥—å-—è–∫—É —Ä—ñ–¥–∏–Ω—É –∑ –∞—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç—É –∞–±–æ –±—É–¥—å-—è–∫—ñ –¥–≤–∞ –∫–∞—Ä—Ç—Ä–∏–¥–∂—ñ –Ω–∞ –≤–∏–±—ñ—Ä.",
        },
        "reviews": {"ru": "–û—Ç–∑—ã–≤—ã", "ua": "–í—ñ–¥–≥—É–∫–∏"},
        "review_prompt": {"ru": "–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤:", "ua": "–ù–∞–ø–∏—à—ñ—Ç—å –≤–∞—à –≤—ñ–¥–≥—É–∫:"},
        "review_added": {"ru": "–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤! –û–Ω –±—É–¥–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.", "ua": "–î—è–∫—É—î–º–æ –∑–∞ –≤—ñ–¥–≥—É–∫! –í—ñ–Ω –±—É–¥–µ —Ä–æ–∑–≥–ª—è–Ω—É—Ç–∏–π –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º."},
        "admin_panel": {"ru": "–°–µ—Ä–≤–µ–º-–ø–∞–Ω–µ–ª—å", "ua": "–°–µ—Ä–≤–µ–º-–ø–∞–Ω–µ–ª—å"},
        "broadcast_prompt": {"ru": "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏ –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º. –ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.", "ua": "–ù–∞–¥—ñ—à–ª—ñ—Ç—å —Ç–µ–∫—Å—Ç —Ä–æ–∑—Å–∏–ª–∫–∏ –æ–¥–Ω–∏–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º. –ë—É–¥–µ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –≤—Å—ñ–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º."},
        "broadcast_ok": {"ru": "–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞. –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è.", "ua": "–†–æ–∑—Å–∏–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞. –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—Å–∏–ª–∞—é—Ç—å—Å—è."},
        "old_button": {"ru": "–ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞. –û—Ç–∫—Ä–æ–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –º–µ–Ω—é.", "ua": "–ö–Ω–æ–ø–∫–∞ –∑–∞—Å—Ç–∞—Ä—ñ–ª–∞. –í—ñ–¥–∫—Ä–∏–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω–µ –º–µ–Ω—é."},
    }
    return texts.get(key, {}).get(lang, texts.get(key, {}).get("ru", key))

def currency(amount: int) -> str:
    return f"{amount} –≥—Ä–Ω"

# ===============================
# --------- BOT INIT ------------
# ===============================

bot = telebot.TeleBot(TOKEN, parse_mode="HTML")

# Global ephemeral states
WAITING_REVIEW: Dict[int, bool] = {}     # uid -> True if waiting for review text
WAITING_BROADCAST: Dict[int, bool] = {}  # admin uid -> True if waiting broadcast text

# ===============================
# -------- MARKUPS --------------
# ===============================

def main_menu_markup(uid: int) -> types.ReplyKeyboardMarkup:
    lang = get_lang(uid)
    role = get_role(uid)
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.row("üìö " + t("catalog", lang), "üß∫ " + t("cart", lang))
    kb.row("üì¶ " + t("orders", lang), "üë• " + t("referral", lang))
    kb.row("‚≠ê " + t("reviews", lang))
    if int(uid) == ADMIN_CHAT_ID or role == "admin":
        kb.row("üõ† " + t("admin_panel", lang), "üì¢ –†–∞—Å—Å—ã–ª–∫–∞")
    return kb

def catalog_menu(lang: str, vt: int) -> types.InlineKeyboardMarkup:
    mk = types.InlineKeyboardMarkup(row_width=1)
    mk.add(
        types.InlineKeyboardButton(t("cartridges", lang), callback_data=f"v{vt}:cat_cartridges"),
        types.InlineKeyboardButton(t("pods", lang), callback_data=f"v{vt}:cat_pods"),
        types.InlineKeyboardButton(t("liquids", lang), callback_data=f"v{vt}:cat_liquids"),
        types.InlineKeyboardButton(t("back", lang), callback_data=f"v{vt}:back_main")
    )
    return mk

def cartridges_menu(lang: str, vt: int) -> types.InlineKeyboardMarkup:
    mk = types.InlineKeyboardMarkup(row_width=1)
    mk.add(
        types.InlineKeyboardButton("Voopoo", callback_data=f"v{vt}:cat_voopoo"),
        types.InlineKeyboardButton("Vaporesso", callback_data=f"v{vt}:cat_vaporesso"),
        types.InlineKeyboardButton("Elf Bar ELFX", callback_data=f"v{vt}:cat_elfx"),
        types.InlineKeyboardButton(t("back", lang), callback_data=f"v{vt}:cat_back")
    )
    return mk

def products_menu(category: str, lang: str, vt: int) -> types.InlineKeyboardMarkup:
    mk = types.InlineKeyboardMarkup(row_width=1)
    for key, p in PRODUCTS.items():
        if p["category"] == category:
            name = p["name_ru"] if lang == "ru" else p["name_ua"]
            mk.add(types.InlineKeyboardButton(f"{name} - {p['price']} –≥—Ä–Ω", callback_data=f"v{vt}:add_{key}"))
    mk.add(types.InlineKeyboardButton(t("back", lang), callback_data=f"v{vt}:cat_cartridges"))
    return mk

def pods_menu(lang: str, vt: int) -> types.InlineKeyboardMarkup:
    mk = types.InlineKeyboardMarkup(row_width=1)
    for key, p in PODS.items():
        name = p["name_ru"] if lang == "ru" else p["name_ua"]
        mk.add(types.InlineKeyboardButton(f"{name} - {p['price']} –≥—Ä–Ω", callback_data=f"v{vt}:add_{key}"))
    mk.add(types.InlineKeyboardButton(t("back", lang), callback_data=f"v{vt}:cat_back"))
    return mk

def liquids_root(lang: str, vt: int) -> types.InlineKeyboardMarkup:
    mk = types.InlineKeyboardMarkup(row_width=1)
    mk.add(
        types.InlineKeyboardButton("Chaser", callback_data=f"v{vt}:liq_chaser"),
        types.InlineKeyboardButton("Elfliq", callback_data=f"v{vt}:liq_elfliq"),
        types.InlineKeyboardButton("Elix", callback_data=f"v{vt}:liq_elix"),
        types.InlineKeyboardButton(t("back", lang), callback_data=f"v{vt}:cat_back"),
    )
    return mk

def liquids_brand_menu(brand: str, lang: str, vt: int) -> types.InlineKeyboardMarkup:
    mk = types.InlineKeyboardMarkup(row_width=1)
    if brand == "chaser":
        mk.add(types.InlineKeyboardButton("Chaser 30ml", callback_data=f"v{vt}:liq_chaser_30"),
               types.InlineKeyboardButton("Chaser 10ml", callback_data=f"v{vt}:liq_chaser_10"))
    elif brand == "elfliq":
        mk.add(types.InlineKeyboardButton("Elfliq 30ml", callback_data=f"v{vt}:liq_elfliq_30"),
               types.InlineKeyboardButton("Elfliq 10ml", callback_data=f"v{vt}:liq_elfliq_10"))
    elif brand == "elix":
        mk.add(types.InlineKeyboardButton("Elix 30ml", callback_data=f"v{vt}:liq_elix_30"),
               types.InlineKeyboardButton("Elix 10ml", callback_data=f"v{vt}:liq_elix_10"))
    mk.add(types.InlineKeyboardButton(t("back", lang), callback_data=f"v{vt}:cat_liquids"))
    return mk

def liquids_products(category: str, lang: str, vt: int) -> types.InlineKeyboardMarkup:
    mk = types.InlineKeyboardMarkup(row_width=1)
    for key, p in LIQUIDS.items():
        if p["category"] == category:
            name = p["name_ru"] if lang == "ru" else p["name_ua"]
            mk.add(types.InlineKeyboardButton(f"{name} - {p['price']} –≥—Ä–Ω", callback_data=f"v{vt}:add_{key}"))
    mk.add(types.InlineKeyboardButton(t("back", lang), callback_data=f"v{vt}:cat_liquids"))
    return mk

# ===============================
# --------- HELPERS -------------
# ===============================

def product_by_key(key: str):
    return LIQUIDS.get(key) or PRODUCTS.get(key) or PODS.get(key)

def format_items(items: List[str], lang: str) -> str:
    lines = []
    for key in items:
        p = product_by_key(key)
        if not p: 
            continue
        name = p["name_ru"] if lang == "ru" else p["name_ua"]
        lines.append(f"‚Ä¢ {name} ‚Äî {currency(p['price'])}")
    return "\n".join(lines) if lines else "‚Äî"

def cart_total(uid: int) -> int:
    total = 0
    for key in get_cart(uid):
        p = product_by_key(key)
        if p:
            total += int(p["price"])
    return total

def send_admin(text: str, reply_markup: Optional[types.InlineKeyboardMarkup]=None):
    try:
        bot.send_message(ADMIN_CHAT_ID, text, reply_markup=reply_markup)
    except Exception as e:
        log.error(f"send_admin error: {e}")

def ref_link(bot_username: str, uid: int) -> str:
    return f"https://t.me/{bot_username}?start={uid}"

# ===============================
# --------- UI FLOWS ------------
# ===============================

@bot.message_handler(commands=["start"])
def cmd_start(message: types.Message):
    uid = message.from_user.id
    ensure_user(uid)

    # referral
    if message.text and " " in message.text:
        parts = message.text.split(maxsplit=1)
        if len(parts) > 1 and parts[1].isdigit():
            add_referral(parent_id=int(parts[1]), child_id=uid)

    lang = get_lang(uid)
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    kb.row("–†—É—Å—Å–∫–∏–π üá∑üá∫", "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ üá∫üá¶")
    bot.send_message(uid, t("language_select", lang), reply_markup=kb)

@bot.message_handler(func=lambda m: m.text in ["–†—É—Å—Å–∫–∏–π üá∑üá∫", "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ üá∫üá¶"])
def on_language(message: types.Message):
    uid = message.from_user.id
    set_lang(uid, "ru" if message.text.startswith("–†—É—Å") else "ua")
    bot.send_message(uid, t("main_menu", get_lang(uid)), reply_markup=main_menu_markup(uid))

@bot.message_handler(commands=["admin"])
def cmd_admin(message: types.Message):
    uid = message.from_user.id
    if uid != ADMIN_CHAT_ID:
        bot.reply_to(message, "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.")
        return
    open_admin_panel(uid, message)

def open_admin_panel(uid: int, message: Optional[types.Message]=None):
    lang = get_lang(uid)
    vt = get_view_token(uid)
    mk = types.InlineKeyboardMarkup(row_width=2)
    mk.add(
        types.InlineKeyboardButton("üì¶ –ó–∞–∫–∞–∑—ã", callback_data=f"v{vt}:admin_orders"),
    )
    mk.add(
        types.InlineKeyboardButton("üë• –†–µ—Ñ–µ—Ä–∞–ª—ã", callback_data=f"v{vt}:admin_referrals"),
        types.InlineKeyboardButton("üì¢ –†–∞—Å—Å—ã–ª–∫–∞", callback_data=f"v{vt}:admin_broadcast"),
    )
    mk.add(types.InlineKeyboardButton(t("back", lang), callback_data=f"v{vt}:back_main"))
    if message:
        bot.send_message(uid, "üõ† –°–µ—Ä–≤–µ–º-–ø–∞–Ω–µ–ª—å", reply_markup=mk)
    else:
        bot.send_message(uid, "üõ† –°–µ—Ä–≤–µ–º-–ø–∞–Ω–µ–ª—å", reply_markup=mk)

@bot.message_handler(func=lambda m: True)
def main_router(message: types.Message):
    uid = message.from_user.id
    text = message.text or ""
    lang = get_lang(uid)

    # Admin-only explicit buttons
    if (text.startswith("üõ†") or text.lower().strip()=="/admin") and uid == ADMIN_CHAT_ID:
        open_admin_panel(uid, message)
        return

    if text.startswith("üì¢"):
        if uid != ADMIN_CHAT_ID:
            bot.reply_to(message, "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.")
            return
        WAITING_BROADCAST[uid] = True
        bot.reply_to(message, t("broadcast_prompt", lang))
        return

    if WAITING_BROADCAST.get(uid):
        WAITING_BROADCAST.pop(uid, None)
        bot.reply_to(message, t("broadcast_ok", lang))
        # send to all users
        for sid in list(USERS.keys()):
            try:
                bot.send_message(int(sid), message.text)
                time.sleep(0.03)
            except Exception:
                pass
        return

    if text.startswith("üìö"):
        vt = get_view_token(uid)
        bot.send_message(uid, t("catalog", lang), reply_markup=catalog_menu(lang, vt))
        return

    if text.startswith("üß∫"):
        show_cart(uid)
        return

    if text.startswith("üì¶"):
        show_orders(uid)
        return

    if text.startswith("üë•"):
        show_referrals(uid)
        return

    if text.startswith("‚≠ê"):
        open_reviews(uid)
        return

    # fallback
    bot.send_message(uid, t("main_menu", lang), reply_markup=main_menu_markup(uid))

def show_cart(uid: int):
    lang = get_lang(uid)
    items = get_cart(uid)
    if not items:
        bot.send_message(uid, t("cart_empty", lang), reply_markup=main_menu_markup(uid))
        return
    vt = get_view_token(uid)
    total = cart_total(uid)
    text = f"üß∫ {t('cart', lang)}:\n\n{format_items(items, lang)}\n\n–ò—Ç–æ–≥–æ: {currency(total)}"
    mk = types.InlineKeyboardMarkup()
    mk.add(types.InlineKeyboardButton(t("checkout", lang), callback_data=f"v{vt}:checkout"))
    mk.add(types.InlineKeyboardButton("–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É", callback_data=f"v{vt}:clear_cart"))
    mk.add(types.InlineKeyboardButton(t("back", lang), callback_data=f"v{vt}:back_main"))
    bot.send_message(uid, text, reply_markup=mk)

def show_orders(uid: int):
    lang = get_lang(uid)
    my = [o for o in ORDERS.values() if o["user_id"] == uid]
    if not my:
        bot.send_message(uid, t("orders_empty", lang))
        return
    for o in sorted(my, key=lambda x: x["id"], reverse=True)[:20]:
        vt = get_view_token(uid)
        items_text = format_items(o["items"], lang)
        status_text = t("order_status_paid", lang) if o.get("paid") else o.get("status", "")
        msg = f"–ó–∞–∫–∞–∑ #{o['id']}:\n{items_text}\n–°—É–º–º–∞: {currency(o['total'])}\n–°—Ç–∞—Ç—É—Å: {status_text}\n–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã: {o.get('payment_method') or '‚Äî'}"
        mk = types.InlineKeyboardMarkup()
        if o.get("paid") and not o.get("confirmed"):
            mk.add(types.InlineKeyboardButton(t("confirm_received", lang), callback_data=f"v{vt}:confirm_{o['id']}"))
        bot.send_message(uid, msg, reply_markup=mk)

def show_referrals(uid: int):
    lang = get_lang(uid)
    refs = REF["map"].get(str(uid), [])
    spent = int(REF["spending"].get(str(uid), 0))
    try:
        me = bot.get_me()
        link = ref_link(me.username, uid)
    except Exception:
        link = f"https://t.me/your_bot?start={uid}"
    bot.send_message(uid, f"–í—ã –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏: {len(refs)} —á–µ–ª–æ–≤–µ–∫(–∞).\n–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –≤–∞—à–∏–º–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏: {currency(spent)}\n{t('referral_link_caption', lang)}\n{link}")

# ===============================
# --------- CALLBACKS -----------
# ===============================

@bot.callback_query_handler(func=lambda c: True)
def on_cb(call: types.CallbackQuery):
    try:
        uid = call.from_user.id
        lang = get_lang(uid)
        data = call.data or ""

        # Extract view token
        if not data.startswith("v") or ":" not in data:
            bot.answer_callback_query(call.id, t("old_button", lang), show_alert=True)
            return
        token_str, action = data.split(":", 1)
        try:
            token = int(token_str[1:])
        except ValueError:
            bot.answer_callback_query(call.id, t("old_button", lang), show_alert=True)
            return

        if get_role(uid) != "admin" and not check_view_token(uid, token):
            bot.answer_callback_query(call.id, "–ö–Ω–æ–ø–∫–∞ –∑–∞—Å—Ç—Ä—è–≥–ª–∞. –í—ñ–¥–∫—Ä–∏–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω–µ –º–µ–Ω—é.")
            return

        # --- NAVIGATION ---
        if action == "back_main":
            bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id, reply_markup=None)
            bot.send_message(uid, t("main_menu", lang), reply_markup=main_menu_markup(uid))
            bot.answer_callback_query(call.id); return

        # Catalog
        if action == "cat_cartridges":
            vt = get_view_token(uid)
            bot.edit_message_text(t("cartridges", lang), uid, call.message.message_id, reply_markup=cartridges_menu(lang, vt))
            bot.answer_callback_query(call.id); return
        if action == "cat_pods":
            vt = get_view_token(uid)
            bot.edit_message_text(t("pods", lang), uid, call.message.message_id, reply_markup=pods_menu(lang, vt))
            bot.answer_callback_query(call.id); return
        if action == "cat_liquids":
            vt = get_view_token(uid)
            bot.edit_message_text(t("liquids", lang), uid, call.message.message_id, reply_markup=liquids_root(lang, vt))
            bot.answer_callback_query(call.id); return
        if action == "cat_back":
            vt = get_view_token(uid)
            bot.edit_message_text(t("catalog", lang), uid, call.message.message_id, reply_markup=catalog_menu(lang, vt))
            bot.answer_callback_query(call.id); return

        # Cartridges brands
        if action == "cat_voopoo":
            vt = get_view_token(uid)
            bot.edit_message_text("Voopoo", uid, call.message.message_id, reply_markup=products_menu("voopoo", lang, vt))
            bot.answer_callback_query(call.id); return
        if action == "cat_vaporesso":
            vt = get_view_token(uid)
            bot.edit_message_text("Vaporesso", uid, call.message.message_id, reply_markup=products_menu("vaporesso", lang, vt))
            bot.answer_callback_query(call.id); return
        if action == "cat_elfx":
            vt = get_view_token(uid)
            bot.edit_message_text("Elf Bar ELFX", uid, call.message.message_id, reply_markup=products_menu("elfx", lang, vt))
            bot.answer_callback_query(call.id); return

        # Liquids brands
        if action == "liq_chaser":
            vt = get_view_token(uid)
            bot.edit_message_text("Chaser", uid, call.message.message_id, reply_markup=liquids_brand_menu("chaser", lang, vt))
            bot.answer_callback_query(call.id); return
        if action == "liq_elfliq":
            vt = get_view_token(uid)
            bot.edit_message_text("Elfliq", uid, call.message.message_id, reply_markup=liquids_brand_menu("elfliq", lang, vt))
            bot.answer_callback_query(call.id); return
        if action == "liq_elix":
            vt = get_view_token(uid)
            bot.edit_message_text("Elix", uid, call.message.message_id, reply_markup=liquids_brand_menu("elix", lang, vt))
            bot.answer_callback_query(call.id); return

        # Liquids sizes
        if action.startswith("liq_"):
            parts = action.split("_")
            if len(parts) == 3:
                _, brand, size = parts
                category = f"{brand}_{size}"
                vt = get_view_token(uid)
                bot.edit_message_text(f"{brand.capitalize()} {size.replace('_',' ')}", uid, call.message.message_id, reply_markup=liquids_products(category, lang, vt))
                bot.answer_callback_query(call.id); return

        # Add item
        if action.startswith("add_"):
            key = action[4:]
            p = product_by_key(key)
            if not p:
                bot.answer_callback_query(call.id, "‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True); return
            add_to_cart(uid, key)
            name = p["name_ru"] if lang == "ru" else p["name_ua"]
            bot.answer_callback_query(call.id, f"‚úÖ {name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É ({p['price']} –≥—Ä–Ω)"); return

        # Cart actions
        if action == "clear_cart":
            clear_cart(uid)
            bot.edit_message_text(t("cart_cleared", lang), uid, call.message.message_id)
            bot.answer_callback_query(call.id); return

        if action == "checkout":
            cart = get_cart(uid)
            if not cart:
                bot.answer_callback_query(call.id, t("cart_empty", lang), show_alert=True); return
            oid = new_order_id()
            total = cart_total(uid)
            ORDERS[str(oid)] = {
                "id": oid,
                "user_id": uid,
                "items": cart.copy(),
                "total": total,
                "status": "created",
                "payment_method": None,
                "paid": False,
                "confirmed": False,
                "created": int(time.time())
            }
            _save(F_ORDERS, ORDERS)
            clear_cart(uid)
            vt2 = get_view_token(uid)
            mk = types.InlineKeyboardMarkup(row_width=1)
            mk.add(types.InlineKeyboardButton(t("pay_cod", lang), callback_data=f"v{vt2}:pay_cod_{oid}"))
            mk.add(types.InlineKeyboardButton(t("pay_card", lang), callback_data=f"v{vt2}:pay_card_{oid}"))
            mk.add(types.InlineKeyboardButton(t("pay_crypto", lang), callback_data=f"v{vt2}:pay_crypto_{oid}"))
            mk.add(types.InlineKeyboardButton(t("back", lang), callback_data=f"v{vt2}:back_main"))
            bot.edit_message_text(t("order_created", lang).format(order_id=oid), uid, call.message.message_id, reply_markup=mk)
            bot.answer_callback_query(call.id); return

        # Payments
        if action.startswith("pay_cod_"):
            oid = int(action.split("_")[-1])
            o = ORDERS.get(str(oid))
            if not o or o["user_id"] != uid:
                bot.answer_callback_query(call.id, "–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True); return
            o["payment_method"] = "cod"; o["paid"] = False; o["status"] = "awaiting_delivery"
            _save(F_ORDERS, ORDERS)
            bot.edit_message_text("–í—ã –≤—ã–±—Ä–∞–ª–∏ –æ–ø–ª–∞—Ç—É –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏.", uid, call.message.message_id)
            it = format_items(o["items"], lang)
            send_admin(f"üÜï –ó–∞–∫–∞–∑ #{oid} –æ—Ç @{call.from_user.username or call.from_user.id}\n–ú–µ—Ç–æ–¥: –ù–∞–ª–æ–∂–µ–Ω–Ω—ã–π –ø–ª–∞—Ç—ë–∂\n–°—É–º–º–∞: {currency(o['total'])}\n–°–æ—Å—Ç–∞–≤:\n{it}")
            bot.answer_callback_query(call.id); return

        if action.startswith("pay_card_"):
            oid = int(action.split("_")[-1])
            o = ORDERS.get(str(oid))
            if not o or o["user_id"] != uid:
                bot.answer_callback_query(call.id, "–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True); return
            o["payment_method"] = "card"; o["paid"] = False; o["status"] = "waiting_confirmation"
            _save(F_ORDERS, ORDERS)
            vt2 = get_view_token(uid)
            mk = types.InlineKeyboardMarkup()
            mk.add(types.InlineKeyboardButton(t("pay_done", lang), callback_data=f"v{vt2}:paid_confirm_{oid}"))
            bot.edit_message_text(t("pay_prepay_info", lang), uid, call.message.message_id, reply_markup=mk)
            bot.answer_callback_query(call.id); return

        if action.startswith("pay_crypto_"):
            oid = int(action.split("_")[-1])
            o = ORDERS.get(str(oid))
            if not o or o["user_id"] != uid:
                bot.answer_callback_query(call.id, "–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True); return
            o["payment_method"] = "crypto"; o["paid"] = False; o["status"] = "waiting_confirmation"
            _save(F_ORDERS, ORDERS)
            vt2 = get_view_token(uid)
            mk = types.InlineKeyboardMarkup()
            mk.add(types.InlineKeyboardButton(t("pay_done", lang), callback_data=f"v{vt2}:paid_confirm_{oid}"))
            bot.edit_message_text(t("pay_crypto_info", lang), uid, call.message.message_id, reply_markup=mk)
            bot.answer_callback_query(call.id); return

        if action.startswith("paid_confirm_"):
            oid = int(action.split("_")[-1])
            o = ORDERS.get(str(oid))
            if not o or o["user_id"] != uid:
                bot.answer_callback_query(call.id, "–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True); return
            o["paid"] = True
            o["status"] = "waiting_admin_confirmation"
            _save(F_ORDERS, ORDERS)
            items_text = format_items(o["items"], lang)
            mk = types.InlineKeyboardMarkup()
            mk.add(types.InlineKeyboardButton("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É", callback_data=f"v{get_view_token(ADMIN_CHAT_ID)}:admin_confirm_{oid}"))
            send_admin(f"üí≥ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{call.from_user.username or call.from_user.id} —Å–æ–æ–±—â–∏–ª –æ–± –æ–ø–ª–∞—Ç–µ –∑–∞–∫–∞–∑–∞ #{oid}.\n–ú–µ—Ç–æ–¥: {o['payment_method']}\n–°—É–º–º–∞: {currency(o['total'])}\n–°–æ—Å—Ç–∞–≤:\n{items_text}", reply_markup=mk)
            bot.edit_message_text(t("pay_done_wait", lang), uid, call.message.message_id)
            bot.answer_callback_query(call.id); return

        if action.startswith("confirm_"):
            oid = int(action.split("_")[-1])
            o = ORDERS.get(str(oid))
            if not o or o["user_id"] != uid:
                bot.answer_callback_query(call.id, "–û—à–∏–±–∫–∞", show_alert=True); return
            o["confirmed"] = True; o["status"] = "completed"
            _save(F_ORDERS, ORDERS)
            bot.edit_message_text(f"–ó–∞–∫–∞–∑ #{oid} {t('order_status_completed', lang)}", uid, call.message.message_id)
            bot.answer_callback_query(call.id); return

        # Reviews
        if action == "review_add":
            WAITING_REVIEW[uid] = True
            bot.send_message(uid, t("review_prompt", lang))
            bot.answer_callback_query(call.id); return
        if action == "review_show":
            approved = [r for r in REVIEWS if r.get("approved")]
            if not approved:
                bot.answer_callback_query(call.id, "–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤.", show_alert=True); return
            text = "\n\n".join([f"@{bot.get_chat(r['user_id']).username or r['user_id']}: {r['text']}" for r in approved[-10:]])
            bot.edit_message_text(text, uid, call.message.message_id)
            bot.answer_callback_query(call.id); return

        # Admin actions
        if action == "admin_orders" and uid == ADMIN_CHAT_ID:
            pending = [
                o for o in sorted(ORDERS.values(), key=lambda x: x["id"], reverse=True)
                if o["status"] not in ["completed", "canceled"]
            ][:30]
            for o in pending:
                vt2 = get_view_token(uid)
                items_text = format_items(o["items"], lang)
                mk = types.InlineKeyboardMarkup(row_width=3)
                mk.add(types.InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É", callback_data=f"v{vt2}:admin_confirm_{o['id']}"))
                mk.add(types.InlineKeyboardButton("üì¶ –ó–∞–≤–µ—Ä—à–∏—Ç—å", callback_data=f"v{vt2}:admin_complete_{o['id']}"))
                mk.add(types.InlineKeyboardButton("üóë –û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"v{vt2}:admin_cancel_{o['id']}"))
                bot.send_message(uid, f"#{o['id']} | {currency(o['total'])} | {o['status']} | {o.get('payment_method') or '‚Äî'}\n{items_text}", reply_markup=mk)
            bot.answer_callback_query(call.id); return

        if action == "admin_reviews" and uid == ADMIN_CHAT_ID:
            for idx, r in enumerate(REVIEWS):
                if not r.get("approved"):
                    vt2 = get_view_token(uid)
                    mk = types.InlineKeyboardMarkup()
                    mk.add(types.InlineKeyboardButton("‚úÖ –†–∞–∑—Ä–µ—à–∏—Ç—å", callback_data=f"v{vt2}:admin_rev_ok_{idx}"))
                    mk.add(types.InlineKeyboardButton("‚ùå –ó–∞–ø—Ä–µ—Ç–∏—Ç—å", callback_data=f"v{vt2}:admin_rev_del_{idx}"))
                    bot.send_message(uid, f"–û—Ç @{bot.get_chat(r['user_id']).username or r['user_id']}:\n{r['text']}", reply_markup=mk)
            bot.answer_callback_query(call.id); return

        if action == "admin_referrals" and uid == ADMIN_CHAT_ID:
            lines = []
            for ref, childs in REF["map"].items():
                spend = int(REF["spending"].get(ref, 0))
                lines.append(f"üë§ {ref}: –ø—Ä–∏–≥–ª–∞—Å–∏–ª {len(childs)}, —Å—É–º–º–∞ {currency(spend)}")
            bot.send_message(uid, "\n".join(lines) if lines else "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.")
            bot.answer_callback_query(call.id); return

        if action == "admin_broadcast" and uid == ADMIN_CHAT_ID:
            WAITING_BROADCAST[uid] = True
            bot.send_message(uid, t("broadcast_prompt", lang))
            bot.answer_callback_query(call.id); return

        if action.startswith("admin_confirm_") and uid == ADMIN_CHAT_ID:
            oid = int(action.split("_")[-1])
            o = ORDERS.get(str(oid))
            if not o:
                bot.answer_callback_query(call.id, "–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True); return
            o["paid"] = True; o["status"] = "paid"
            _save(F_ORDERS, ORDERS)
            buyer = o["user_id"]
            bot.send_message(buyer, t("pay_confirmed", get_lang(buyer)))
            bot.answer_callback_query(call.id, f"–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω #{oid}")
            # referral
            # find referrer
            referrer = None
            for r, lst in REF["map"].items():
                if str(buyer) in lst:
                    referrer = int(r); break
            if referrer:
                add_spending(referrer, o["total"])
                spent = int(REF["spending"].get(str(referrer), 0))

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ø–æ—Ä–æ–≥ –∏ –Ω–∞–≥—Ä–∞–¥–∞ –µ—â—ë –Ω–µ –≤—ã–¥–∞–≤–∞–ª–∞—Å—å
                if spent >= REF_REWARD_THRESHOLD:
                    if not REF.get("rewards", {}).get(str(referrer)):
                        bot.send_message(
                            referrer,
                            t("referral_notify", get_lang(referrer)).format(sum=spent)
            )
            # –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –Ω–∞–≥—Ä–∞–¥–∞ –≤—ã–¥–∞–Ω–∞
            REF.setdefault("rewards", {})[str(referrer)] = True
            _save(F_REFERRALS, REF)

            return

        if action.startswith("admin_complete_") and uid == ADMIN_CHAT_ID:
            oid = int(action.split("_")[-1])
            o = ORDERS.get(str(oid))
            if not o:
                bot.answer_callback_query(call.id, "–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True); return
            o["status"] = "completed"
            _save(F_ORDERS, ORDERS)
            bot.answer_callback_query(call.id, f"–ó–∞–≤–µ—Ä—à–µ–Ω #{oid}"); return

        if action.startswith("admin_cancel_") and uid == ADMIN_CHAT_ID:
            oid = int(action.split("_")[-1])
            o = ORDERS.get(str(oid))
            if not o:
                bot.answer_callback_query(call.id, "–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True); return
            o["status"] = "canceled"
            _save(F_ORDERS, ORDERS)
            bot.answer_callback_query(call.id, f"–û—Ç–º–µ–Ω–µ–Ω #{oid}"); return

        if action.startswith("admin_rev_ok_") and uid == ADMIN_CHAT_ID:
            idx = int(action.split("_")[-1])
            if approve_review(idx):
                bot.answer_callback_query(call.id, "–û–¥–æ–±—Ä–µ–Ω–æ")
            else:
                bot.answer_callback_query(call.id, "–û—à–∏–±–∫–∞", show_alert=True)
            return

        if action.startswith("admin_rev_del_") and uid == ADMIN_CHAT_ID:
            idx = int(action.split("_")[-1])
            if delete_review(idx):
                bot.answer_callback_query(call.id, "–£–¥–∞–ª–µ–Ω–æ")
            else:
                bot.answer_callback_query(call.id, "–û—à–∏–±–∫–∞", show_alert=True)
            return

    except Exception as e:
        log.exception("callback error")
        try:
            bot.answer_callback_query(call.id, "–û—à–∏–±–∫–∞")
        except Exception:
            pass

@bot.message_handler(func=lambda m: WAITING_REVIEW.get(m.from_user.id) is True, content_types=["text"])
def on_review_text(message: types.Message):
    uid = message.from_user.id
    lang = get_lang(uid)
    text = message.text.strip()
    if len(text) < 3:
        bot.reply_to(message, "–û—Ç–∑—ã–≤ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
        return
    WAITING_REVIEW.pop(uid, None)
    add_review(uid, text)
    bot.reply_to(message, t("review_added", lang))
    # send to admin
    idx = len(REVIEWS) - 1
    mk = types.InlineKeyboardMarkup()
    vt = get_view_token(ADMIN_CHAT_ID)
    mk.add(types.InlineKeyboardButton("‚úÖ –†–∞–∑—Ä–µ—à–∏—Ç—å", callback_data=f"v{vt}:admin_rev_ok_{idx}"))
    mk.add(types.InlineKeyboardButton("‚ùå –ó–∞–ø—Ä–µ—Ç–∏—Ç—å", callback_data=f"v{vt}:admin_rev_del_{idx}"))
    send_admin(f"–ù–æ–≤—ã–π –æ—Ç–∑—ã–≤ –æ—Ç @{message.from_user.username or uid}:\n\n{text}", reply_markup=mk)

# ===============================
# --------- POLLING -------------
# ===============================

def main():
    log.info("Bot starting...")
    bot.infinity_polling(skip_pending=True, timeout=30, long_polling_timeout=30)

if __name__ == "__main__":
    main()
